<script context="module">
	const colorVisionMatrices = {
		normal: [
			1, 0, 0, 0, 0,
			0, 1, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		protanomaly: [
			0.152,  1.053, -0.205,  0.000,  0.000,
			0.115,  0.786,  0.099,  0.000,  0.000,
			-0.004, -0.048,  1.052,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000,  0.000
		],
		deuteranomaly: [
			0.367,  0.861, -0.228,  0.000,  0.000,
			0.280,  0.673,  0.047,  0.000,  0.000,
			-0.012,  0.043,  0.969,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000, 0.000
		],
		tritanomaly: [
			1.256, -0.077, -0.179,  0.000,  0.000,
			-0.078,  0.931,  0.148,  0.000,  0.000,
			0.005,  0.691,  0.304,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000,  0.000
		],
		achromanomaly: [
          0.213,  0.715,  0.072,  0.000,  0.000,
          0.213,  0.715,  0.072,  0.000,  0.000,
          0.213,  0.715,  0.072,  0.000,  0.000,
          0.000,  0.000,  0.000,  1.000,  0.000
		]
	};
	const remappers = {
		normal: [
			1, 0, 0, 0, 0,
			0, 1, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		protanomaly: [
			0.5, 0, 0.5, 0, 0,
			0, 1, 0, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 0, 1, 0
		],
		deuteranomaly: [
			0, 0.5, 0.5, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		tritanomaly: [
			0.5, 0, 0.5, 0, 0,
			0, 1, 0, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 0, 1, 0
		],
		achromanomaly: [
			1, 0, 0, 0, 0,
			0, 1, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		]
	}
</script>

<script>
	// import { tick } from "svelte";

	export let options = {
		active: false,
		invert: 0,
		hue: 0,
		saturation: 0,
		contrast: 0,
		brightness: 0,
		colorVision: "normal",
		remap: 0,
		texture: 0,
		simulate: false,
	};

	const rerender = () => {
		const active = options.active;
		options.active = false;
		setTimeout(() => (options.active = active), 0);
	};

	/*
	const rerender1 = async () => {
		const active = options.active;
		options.active = false;
		await tick();
		options.active = active
	};
	*/

	$: options, rerender();
</script>

<svg width="0" height="0">
	<defs>
		<filter id="correction">
			{#if options.remap && options.colorVision !== "normal"}
				<feColorMatrix
					in="SourceGraphic"
					values={remappers[options.colorVision]}
					result="corrected"
				/>
			{/if}

			{#if options.texture && options.colorVision !== "normal"}
				<feColorMatrix
					values={colorVisionMatrices[options.colorVision]}
					result="corrected"
				/>
				<feColorMatrix
					values="-1 0 0 0 1
							0 -1 0 0 1
							0 0 -1 0 1
							0 0 0 1 0"
					in="SourceGraphic"
					result="inverted"
				/>
				<feComposite
					operator="arithmetic"
					k2="1"
					k3="1"
					in="corrected"
					in2="inverted"
					result="difference"
				/>
				<feColorMatrix
					in="substracted"
					values="-1 0 0 0 1
							0 -1 0 0 1
							0 0 -1 0 1
							0 0 0 1 0"
					result="difference"
				/>
				<feColorMatrix
					in="substracted"
					values="3 0 0 0 0
							0 4 0 0 0
							0 0 2 0 0
							0 0 0 1 0"
					result="difference"
				/>
				<feTurbulence
					baseFrequency="0.15 0.15"
					type="fractalNoise"
					result="noise"
				/>
				<feComposite
					operator="atop"
					k2="1"
					k3="1"
					in="noise"
					in2="difference"
					result="texture"
				/>
				<feBlend
					mode="multiply"
					in="texture"
					in2="difference"
					result="texture1"
				/>

				<feColorMatrix
					in="texture1"
					values="0 2 0 0 -1
							0 0 2 0 -1
							2 0 0 0 -1
							0 0 0 1 0"
					result="texture2"
				/>
				<feBlend
					mode="screen"
					in="texture2"
					in2="corrected"
					result="texture1"
				/>
			{/if}

			<feComponentTransfer>
				<feFuncR type="linear" slope={options.brightness} />
				<feFuncG type="linear" slope={options.brightness} />
				<feFuncB type="linear" slope={options.brightness} />
			</feComponentTransfer>
			<feComponentTransfer>
				<feFuncR type="linear" slope={options.contrast} intercept={-(0.5 * options.contrast - 0.5)} />
				<feFuncG type="linear" slope={options.contrast} intercept={-(0.5 * options.contrast - 0.5)} />
				<feFuncB type="linear" slope={options.contrast} intercept={-(0.5 * options.contrast - 0.5)} />
			</feComponentTransfer>

			{#if options.simulate}
				<feColorMatrix
					values={colorVisionMatrices[options.colorVision]}
				/>
			{/if}
		</filter>
	</defs>
</svg>

<style>
	:global(.color-corrected) {
		filter: url(#correction);
	}
</style>
