<script context="module">
	const colorVisionMatrices = {
		normal: [
			1, 0, 0, 0, 0,
			0, 1, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		protanomaly: [
			0.152,  1.053, -0.205,  0.000,  0.000,
			0.115,  0.786,  0.099,  0.000,  0.000,
			-0.004, -0.048,  1.052,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000,  0.000
		],
		deuteranomaly: [
			0.367,  0.861, -0.228,  0.000,  0.000,
			0.280,  0.673,  0.047,  0.000,  0.000,
			-0.012,  0.043,  0.969,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000, 0.000
		],
		tritanomaly: [
			1.256, -0.077, -0.179,  0.000,  0.000,
			-0.078,  0.931,  0.148,  0.000,  0.000,
			0.005,  0.691,  0.304,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000,  0.000
		],
		achromanomaly: [
          0.213,  0.715,  0.072,  0.000,  0.000,
          0.213,  0.715,  0.072,  0.000,  0.000,
          0.213,  0.715,  0.072,  0.000,  0.000,
          0.000,  0.000,  0.000,  1.000,  0.000
		]
	};
	const remappers = {
		normal: [
			1, 0, 0, 0, 0,
			0, 1, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		protanomaly: [
			0.5, 0, 0.5, 0, 0,
			0, 1, 0, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 0, 1, 0
		],
		deuteranomaly: [
			0, 0.5, 0.5, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		tritanomaly: [
			0.5, 0, 0.5, 0, 0,
			0, 1, 0, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 0, 1, 0
		],
		achromanomaly: [
			1, 0, 0, 0, 0,
			0, 1, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		]
	}
</script>

<script>
	export let options = {
		active: false,
		colorVision: "normal",
		remap: 1,
		simulate: false,
	};

	// Chrome needs to destroy and rerender the svg defs in order for 
	// CSS filters to be updated. Firefox doesn't need this.
	const rerender = () => {
		const active = options.active;
		options.active = false;
		setTimeout(() => (options.active = active), 0);
	};

	$: options, rerender();
</script>

<svg width="0" height="0">
	<defs>
		<filter id="correction">
			{#if options.remap && options.colorVision !== "normal"}
				<feColorMatrix
					in="SourceGraphic"
					values={remappers[options.colorVision]}
					result="corrected"
				/>
			{/if}

			{#if options.simulate}
				<feColorMatrix
					values={colorVisionMatrices[options.colorVision]}
				/>
			{/if}
		</filter>
	</defs>
</svg>

<style>
	:global(.color-corrected) {
		filter: url(#correction);
	}
</style>
