<script context="module">
	// from https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/css/vision_deficiency.cc;l=24-78;drc=25c9d397f8ece542feaf21ad680b71f161edf47b:
	// The filter color matrices are based on the following research paper:
	// Gustavo M. Machado, Manuel M. Oliveira, and Leandro A. F. Fernandes,
	// "A Physiologically-based Model for Simulation of Color Vision Deficiency".
	// IEEE Transactions on Visualization and Computer Graphics. Volume 15 (2009),
	// Number 6, November/December 2009. pp. 1291-1298.
	// https://www.inf.ufrgs.br/~oliveira/pubs_files/CVD_Simulation/CVD_Simulation.html
	const colorVisionMatrices = {
		normal: [
			1, 0, 0, 0, 0,
			0, 1, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		protanomaly: [
			0.152,  1.053, -0.205,  0.000,  0.000,
			0.115,  0.786,  0.099,  0.000,  0.000,
			-0.004, -0.048,  1.052,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000,  0.000
		],
		deuteranomaly: [
			0.367,  0.861, -0.228,  0.000,  0.000,
			0.280,  0.673,  0.047,  0.000,  0.000,
			-0.012,  0.043,  0.969,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000, 0.000
		],
		tritanomaly: [
			1.256, -0.077, -0.179,  0.000,  0.000,
			-0.078,  0.931,  0.148,  0.000,  0.000,
			0.005,  0.691,  0.304,  0.000,  0.000,
			0.000,  0.000,  0.000,  1.000,  0.000
		]
	};

	// The values for the recoloring matrices are not from official sources and
	// are only tentative.
	const remappers = {
		normal: [
			1, 0, 0, 0, 0,
			0, 1, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		protanomaly: [
			0.5, 0, 0.5, 0, 0,
			0, 1, 0, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 0, 1, 0
		],
		deuteranomaly: [
			0, 0.5, 0.5, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 1, 0, 0,
			0, 0, 0, 1, 0
		],
		tritanomaly: [
			0.5, 0, 0.5, 0, 0,
			0, 1, 0, 0, 0,
			0.5, 0.5, 0, 0, 0,
			0, 0, 0, 1, 0
		]
	}
</script>

<script>
	export let options = {
		active: false,
		colorVision: "normal",
		remap: 1,
		simulate: false,
	};

	// Chrome needs to destroy and rerender the svg defs in order for 
	// CSS filters to be updated. Firefox doesn't need this.
	const rerender = () => {
		const active = options.active;
		options.active = false;
		setTimeout(() => (options.active = active), 0);
	};

	$: options, rerender();
</script>

<svg width="0" height="0">
	<defs>
		<filter id="correction">
			{#if options.remap && options.colorVision !== "normal"}
				<feColorMatrix
					in="SourceGraphic"
					values={remappers[options.colorVision]}
					result="corrected"
				/>
			{/if}

			{#if options.simulate}
				<feColorMatrix
					values={colorVisionMatrices[options.colorVision]}
				/>
			{/if}
		</filter>
	</defs>
</svg>

<style>
	:global(.color-corrected) {
		filter: url(#correction);
	}
</style>
