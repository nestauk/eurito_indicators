<script context='module'>
	import * as _ from 'lamb';

	const buildCycler = _.pipe([
		_.collect([
			_.identity,
			_.rotateBy(-1)
		]),
		_.apply(_.make)
	]);

	const makeCycleUsing = (cycle, getValue, setValue) => {
		const nextInCycle = buildCycler(cycle);
		return () => {
			setValue(nextInCycle[getValue()] || cycle[0]);
		};
	};

	const makeCycleUsingAndStore = (cycle, store) => makeCycleUsing(
		cycle, 
		() => get(store), 
		value => store.set(value)
	);

	const makeCycleUsingAndStoreProp = (cycle, store, prop) => makeCycleUsing(
		cycle,
		() => get(store)[prop],
		value => {
			const options = get(store);
			options[prop] = value;
			store.set(options);
		}
	);
</script>

<script>
	import {onMount} from 'svelte';
	import {get} from 'svelte/store';
	import {
		fontFamily, 
		fontScaling, 
		fontVariationSettings,
		letterSpacing,
		wordSpacing,
		lineHeight
	} from 'app/stores/font';

	import {colorCorrectionOptions} from 'app/stores/color';

	const fonts = [
		'Archivo',
		'Avenir Next Variable',
		'Noboto Flex',
		'Open Dyslexia'
	];
	const fontScales = [1.0, 1.25, 0.75];
	const lineHeights = [1.5, 2.0, 1.25];
	const wordSpacings = ['0rem', '0.2rem', '0.4rem'];
	const letterSpacings = ['0rem', '0.1rem', '0.2rem'];
	const fontVariations = {
		'Archivo': [
			'"wdth" 100, "wght" 300',
			'"wdth" 125, "wght" 300',
			'"wdth" 80, "wght" 300'
		],
		'Avenir Next Variable': [
			'"wdth" 100',
			'"wdth" 75',
			'"wdth" 88'
		],
		'Noboto Flex': [
			'"wght" 100',
			'"wght" 150',
			'"wght" 200',
			'"wght" 50',			
		],

	};

	const simulations = ['none', 'protanopia', 'deuteranopia', 'tritanopia'];
	const inverts = [0, 100];
	const colorModels = ['identity', 'protanopia', 'deuteranopia', 'tritanopia', 'hue', 'grayscale'];
	const hues = [0, 60, 120, 180, 240, 300];
	const grayscales = [0, 30, 60, 100];
	const brightnesses = [100, 125, 150, 50, 75];
	const contrasts = [100, 125, 150, 50, 75];

	let variationsEnabled = true;
	let nextVariations = _.mapValues(fontVariations, buildCycler);

	const cycleVariation = () => {
		if (!variationsEnabled) {
			return;
		}
		const fontName = get(fontFamily);

		const nextSettings =  nextVariations[fontName][get(fontVariationSettings)]
			|| fontVariations[fontName][0];
		fontVariationSettings.set(nextSettings);
	}

	const cycleFont = makeCycleUsing(
		fonts,
		() => get(fontFamily),
		value => {
			fontFamily.set(value);
			variationsEnabled = value in fontVariations;
			fontVariationSettings.set('');
			cycleVariation();
		}
	);

	const cycleSize = makeCycleUsingAndStore(fontScales, fontScaling);
	const cycleLineHeight = makeCycleUsingAndStore(lineHeights, lineHeight);
	const cycleLetterSpacing = makeCycleUsingAndStore(
		letterSpacings,
		letterSpacing
	);
	const cycleWordSpacing = makeCycleUsingAndStore(
		wordSpacings,
		wordSpacing
	);
	const cycleInverts = makeCycleUsingAndStoreProp(
		inverts,
		colorCorrectionOptions,
		'invert'
	);
	const cycleColorModels = makeCycleUsingAndStoreProp(
		colorModels,
		colorCorrectionOptions,
		'colorModel'
	);
	const cycleHues = makeCycleUsingAndStoreProp(
		hues,
		colorCorrectionOptions,
		'hue-rotate'
	);
	const cycleGrayscales = makeCycleUsingAndStoreProp(
		grayscales,
		colorCorrectionOptions,
		'grayscale'
	);
	const cycleBrightnesses = makeCycleUsingAndStoreProp(
		brightnesses,
		colorCorrectionOptions,
		'brightness'
	);
	const cycleContrasts = makeCycleUsingAndStoreProp(
		contrasts,
		colorCorrectionOptions,
		'contrast'
	);
	const cycleSimulations = makeCycleUsingAndStoreProp(
		simulations,
		colorCorrectionOptions,
		'simulate'
	);

	const toggleActive = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.active = !ccOptions.active;
		colorCorrectionOptions.set(ccOptions);
	}

	onMount( () => {
		cycleFont();
		cycleLineHeight();
		cycleWordSpacing();
		cycleLetterSpacing();
	})
</script>

<div>
	<header>Fonts and Text</header>
	<button on:click={cycleFont}>Font: {$fontFamily}</button>
	<button on:click={cycleSize}>Scale: {$fontScaling}</button>
	<button on:click={cycleLineHeight}>Line height: {$lineHeight}</button>
	<button on:click={cycleLetterSpacing}>Letter spacing: {$letterSpacing}</button>
	<button on:click={cycleWordSpacing}>Word spacing: {$wordSpacing}</button>
	<button disabled={!variationsEnabled} on:click={cycleVariation}>Settings: {$fontVariationSettings}</button>
	<header>Color Vision Deficiencies</header>
	<button on:click={toggleActive}>Active: {$colorCorrectionOptions.active}</button>
	<button on:click={cycleSimulations}>Simulate: {$colorCorrectionOptions.simulate}</button>
	<button on:click={cycleInverts}>Invert: {$colorCorrectionOptions.invert}%</button>
	<button on:click={cycleColorModels}>Model: {$colorCorrectionOptions.colorModel}</button>
	{#if $colorCorrectionOptions.colorModel === 'hue'}
		<button on:click={cycleHues}>Hue: {$colorCorrectionOptions['hue-rotate']}deg</button>
	{:else if $colorCorrectionOptions.colorModel === 'grayscale'}
		<button on:click={cycleGrayscales}>Grayscale: {$colorCorrectionOptions.grayscale}%</button>
	{/if}
	<button on:click={cycleBrightnesses}>Brightness: {$colorCorrectionOptions.brightness}%</button>
	<button on:click={cycleContrasts}>Contrast: {$colorCorrectionOptions.contrast}%</button>
</div>

<style>
	div {
		position: fixed;
		top: 48px;
		left: 48px;
		background: white;
		border: thin solid black;
		z-index: 1;
	}
	button {
		display: block;
	}
	header {
		font-family: sans-serif;
		font-size: 16px;
	}
</style>