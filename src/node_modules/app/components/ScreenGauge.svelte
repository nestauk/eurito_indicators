<script context='module'>
	import {writable} from 'svelte/store';

	export const screenGauge = writable();
</script>
<script>
	import {onMount, /* createEventDispatcher */} from 'svelte';

	// TODO Support stores AND events too? Uncomment to restore
	// const dispatch = createEventDispatcher();

	export let fontSize;
	export let bands = [40, 60, 80, 100];
	export let devMode = false;

	let mounted = false;
	let sampleWidth, sampleHeight;

	function computeDimensions (width, height) {
		const display = {
			width: window.innerWidth,
			height: window.innerHeight,
			orientation: window.screen.orientation,
			pixelRatio: window.devicePixelRatio,
			aspect: window.innerWidth / window.innerHeight,
		};
		const glyph = {
			width,
			height,
		}
		const text = {
			width: display.width / glyph.width,
			height: display.height / glyph.height,
		}
		return {
			display,
			glyph,
			text,
		};
	}

	function computeFlags (dimensions) {
		return {
			...dimensions,
			size: {
				xSmall: dimensions.text.width < bands[0],
				small: dimensions.text.width < bands[1],
				medium: dimensions.text.width >= bands[1]
					&& dimensions.text.width <= bands[2],
				large: dimensions.text.width > bands[2],
				xLarge: dimensions.text.width > bands[3],
			},
			orientation: {
				portrait: dimensions.display.aspect < 1,
				landscape: dimensions.display.aspect >= 1,
			},
		}
	}

	function resizing () {
		if (!mounted) {
			return;
		}
		const dimensions = computeDimensions(sampleWidth, sampleHeight);
		const measures = computeFlags(dimensions);
		measures.sizeId = measures.size.medium
			? 'medium'
			: measures.size.small 
				? measures.size.xSmall
					? 'x small'
					: 'small'
				: measures.size.xLarge
					? 'x large'
					: 'large'
		screenGauge.set(measures);
		// dispatch('resize', flags); // event support
	}

	onMount(() => {
		mounted = true;
		resizing();
		window.addEventListener('resize', resizing);
		return () => {
			window.removeEventListener('resize', resizing);
		}
	});

	$: fontSize && resizing();
	$: sampleHeight, sampleWidth, resizing();
</script>

<div>
	<span
		bind:offsetWidth={sampleWidth}
		bind:offsetHeight={sampleHeight}
		style={fontSize && `font-size: ${fontSize}` }
	>x</span>
</div>

{#if devMode && $screenGauge}
	<p class='info'>
		DPPR: {$screenGauge?.display.pixelRatio.toPrecision(4)} <br />
		Display: {$screenGauge?.display.width} 
		x {$screenGauge?.display.height} px<super>2</super><br />
		Text: {$screenGauge?.text.width.toFixed(0)}
		x {$screenGauge?.text.height.toFixed(0)} chars<super>2</super><br />
		size: {$screenGauge?.sizeId} <br />
		orientation: {$screenGauge?.display.aspect > 1 ? 'landscape' : 'portrait'}
	</p>
{/if}

<style>
	div {
		visibility: hidden;
		overflow: hidden;
		background: blue;
		position: fixed;
		top: 0;
		left: 0;

		pointer-events: none;
	}
	span {
		display: block;
	}
	.info {
		position: fixed;
		background: #600c;
		color: white;
		padding: 0.5em;
		box-shadow: 2px 2px 2px #0005;
		width: 50vw;
		left: 25vw;
		top: 4em;
	}
</style>