<script context='module'>
	import {writable} from 'svelte/store';

	export const screenGauge = writable();
</script>
<script>
	import {onMount, /* createEventDispatcher */} from 'svelte';

	// TODO Support stores AND events too? Uncomment to restore
	// const dispatch = createEventDispatcher();

	export let fontSize;
	export let bands = [40, 60, 80, 100];

	let mounted = false;
	let sampleWidth, sampleHeight;

	function computeDimensions (width, height) {
		const display = {
			width: window.screen.width,
			height: window.screen.height,
			orientation: window.screen.orientation,
			pixelRatio: window.devicePixelRatio,
			aspect: window.screen.width / window.screen.height,
		};
		const glyph = {
			width,
			height,
		}
		const text = {
			width: window.screen.width / glyph.width,
			height: window.screen.height / glyph.height,
		}
		return {
			display,
			glyph,
			text,
		};
	}

	function computeFlags (dimensions) {
		return {
			...dimensions,
			size: {
				xSmall: dimensions.text.width < bands[0],
				small: dimensions.text.width < bands[1],
				medium: dimensions.text.width >= bands[1]
					&& dimensions.text.width <= bands[2],
				large: dimensions.text.width > bands[2],
				xLarge: dimensions.text.width > bands[3],
			},
			orientation: {
				portrait: dimensions.display.aspect < 1,
				landscape: dimensions.display.aspect >= 1,
			},
		}
	}

	function resizing () {
		if (!mounted) {
			return;
		}
		const dimensions = computeDimensions(sampleWidth, sampleHeight);
		const measures = computeFlags(dimensions);
		measures.sizeId = measures.size.medium
			? 'medium'
			: measures.size.small 
				? measures.size.xSmall
					? 'xsmall'
					: 'small'
				: measures.size.xLarge
					? 'xlarge'
					: 'large'
		screenGauge.set(measures);
		// dispatch('resize', flags); // event support
	}

	onMount(() => {
		mounted = true;
		resizing();
		window.addEventListener('resize', resizing);
		return () => {
			window.removeEventListener('resize', resizing);
		}
	});

	$: fontSize && resizing();
	$: sampleHeight, sampleWidth, resizing();
</script>

<div>
	<span
		bind:offsetWidth={sampleWidth}
		bind:offsetHeight={sampleHeight}
		style={fontSize && `font-size: ${fontSize}` }
	>x</span>
</div>

<style>
	div {
		visibility: hidden;
		width: 0;
		height: 0;
		overflow: hidden;

		background: blue;
		position: fixed;
		top: 0;
		left: 0;
	}
</style>