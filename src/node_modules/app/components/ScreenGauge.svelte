<script context='module'>
	import {writable} from 'svelte/store';

	export const screenGauge = writable();
</script>
<script>
	import {onMount, /* createEventDispatcher */} from 'svelte';
	import * as _ from 'lamb';

	// TODO Support per-instance stores AND/OR events too?
	// Possibly useful for managing multiple windows.

	export let fontSize;
	export let bands = [40, 60, 80, 100];
	export let devMode = false;

	let mounted = false;
	let sampleWidth, sampleHeight;

	function computeDimensions (width, height) {
		const display = {
			width: window.innerWidth,
			height: window.innerHeight,
			orientation: window.screen.orientation,
			pixelRatio: window.devicePixelRatio,
			aspect: window.innerWidth / window.innerHeight,
		};
		const glyph = {
			width,
			height,
		}
		const text = {
			width: display.width / glyph.width,
			height: display.height / glyph.height,
		}
		return {
			display,
			glyph,
			text,
		};
	}

	function computeFlags (dimensions) {
		return {
			...dimensions,
			size: {
				xSmall: dimensions.text.width < bands[0],
				small: true,
				medium: dimensions.text.width >= bands[1],
				large: dimensions.text.width >= bands[2],
				xLarge: dimensions.text.width >= bands[3],
			},
			orientation: {
				portrait: dimensions.display.aspect < 1,
				landscape: dimensions.display.aspect >= 1,
			},
		}
	}

	function resizing () {
		if (!mounted) {
			return;
		}
		const dimensions = computeDimensions(sampleWidth, sampleHeight);
		const measures = computeFlags(dimensions);
		measures.classes = _.pipe([
			_.pairs,
			_.filterWith(_.getAt(1)),
			_.mapWith(_.getAt(0)),
			_.joinWith(' ')
		])(measures.size);
		screenGauge.set(measures);
	}

	onMount(() => {
		mounted = true;
		resizing();
		window.addEventListener('resize', resizing);
		return () => {
			window.removeEventListener('resize', resizing);
		}
	});

	$: fontSize && resizing();
	$: sampleHeight, sampleWidth, resizing();
</script>

<div>
	<span
		bind:offsetWidth={sampleWidth}
		bind:offsetHeight={sampleHeight}
		style={fontSize && `font-size: ${fontSize}` }
	>x</span>
</div>

{#if devMode && $screenGauge}
	<p class='info'>
		DPPR: {$screenGauge?.display.pixelRatio.toPrecision(4)} <br />
		Display: {$screenGauge?.display.width} 
		x {$screenGauge?.display.height} px<sup>2</sup><br />
		Text: {$screenGauge?.text.width.toFixed(0)}
		x {$screenGauge?.text.height.toFixed(0)} chars<sup>2</sup><br />
		size: {$screenGauge?.classes} <br />
		orientation: {$screenGauge?.display.aspect > 1 ? 'landscape' : 'portrait'} <br />
		<button on:click={() => devMode = false}>Close</button>
	</p>
{/if}

<style>
	div {
		visibility: hidden;
		overflow: hidden;
		background: blue;
		position: fixed;
		top: 0;
		left: 0;

		pointer-events: none;
	}
	span {
		display: block;
	}
	.info {
		position: fixed;
		background: #600c;
		color: white;
		padding: 0.5em;
		box-shadow: 2px 2px 2px #0005;
		width: 50vw;
		left: 25vw;
		top: 4em;
		z-index: --z-1000;
	}
</style>