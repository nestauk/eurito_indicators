<script context='module'>
	import * as _ from 'lamb';

	const buildCycler = _.pipe([
		_.collect([
			_.identity,
			_.rotateBy(-1)
		]),
		_.apply(_.make)
	]);

	const cycleUsingAndStore = (cycle, store, key) => {
		const nextInCycle = buildCycler(cycle);
		return () => {
			const options = get(store);
			options[key] = nextInCycle[options[key]] || cycle[0];
			store.set(options);
		}
	}
</script>

<script>
	import {onMount} from 'svelte';
	import {get} from 'svelte/store';
	import {
		fontFamily, 
		fontScaling, 
		fontVariationSettings,
		letterSpacing,
		wordSpacing,
		lineHeight
	} from 'app/stores/font';

	import {colorCorrectionOptions} from 'app/stores/color';

	const fonts = [
		'Archivo',
		'Avenir Next Variable',
		'Noboto Flex',
		'Open Dyslexia'
	];
	const fontScales = [1.0, 1.25, 0.75];
	const lineHeights = [1.5, 2.0, 1.25];
	const wordSpacings = ['0rem', '0.2rem', '0.4rem'];
	const letterSpacings = ['0rem', '0.1rem', '0.2rem'];
	const fontVariations = {
		'Archivo': [
			'"wdth" 100, "wght" 300',
			'"wdth" 125, "wght" 300',
			'"wdth" 80, "wght" 300'
		],
		'Avenir Next Variable': [
			'"wdth" 100',
			'"wdth" 75',
			'"wdth" 88'
		],
		'Noboto Flex': [
			'"wght" 100',
			'"wght" 150',
			'"wght" 200',
			'"wght" 50',			
		],

	};

	const inverts = [0, 100];
	const colorModels = ['identity', 'protanopia', 'deuteranopia', 'tritanopia', 'hue', 'grayscale'];
	const hues = [0, 60, 120, 180, 240, 300];
	const grayscales = [0, 30, 60, 100];
	const brightnesses = [100, 125, 150, 50, 75];
	const contrasts = [100, 125, 150, 50, 75];

	const nextFonts = buildCycler(fonts);
	const nextSizes = buildCycler(fontScales);
	const nextWordSpacings = buildCycler(wordSpacings);
	const nextLetterSpacings = buildCycler(letterSpacings);
	const nextLineHeights = buildCycler(lineHeights);
	let nextVariations = _.mapValues(fontVariations, buildCycler);

	/*
	const nextColorModels = buildCycler(colorModels);
	const nextHues = buildCycler(hues);
	const nextGrayscales = buildCycler(grayscales);
	*/

	let variationsEnabled = true;

	const cycleVariation = () => {
		if (!variationsEnabled) {
			return;
		}
		const fontName = get(fontFamily);

		const nextSettings =  nextVariations[fontName][get(fontVariationSettings)]
			|| fontVariations[fontName][0];
		fontVariationSettings.set(nextSettings);
	}
	const cycleFont = () => {
		const nextFontName = nextFonts[get(fontFamily)] || fonts[0];
		fontFamily.set(nextFontName);
		variationsEnabled = nextFontName in fontVariations;
		fontVariationSettings.set('');
		cycleVariation();
	}
	const cycleSize = () => {
		const nextSize = nextSizes[get(fontScaling)] || fontScales[0];
		fontScaling.set(nextSize);
	}
	const cycleLineHeight = () => {
		const nextLineHeight = nextLineHeights[get(lineHeight)] || lineHeights[0];
		lineHeight.set(nextLineHeight);
	}
	const cycleLetterSpacing = () => {
		const nextLetterSpacing = nextLetterSpacings[get(letterSpacing)] || letterSpacings[0];
		letterSpacing.set(nextLetterSpacing);
	}
	const cycleWordSpacing = () => {
		const nextWordSpacing = nextWordSpacings[get(wordSpacing)] || wordSpacings[0];
		wordSpacing.set(nextWordSpacing);
	}


	const cycleInverts = cycleUsingAndStore(inverts, colorCorrectionOptions, 'invert');
	const cycleColorModels = cycleUsingAndStore(colorModels, colorCorrectionOptions, 'colorModel');
	const cycleHues = cycleUsingAndStore(hues, colorCorrectionOptions, 'hue-rotate');
	const cycleGrayscales = cycleUsingAndStore(grayscales, colorCorrectionOptions, 'grayscale');
	const cycleBrightnesses = cycleUsingAndStore(brightnesses, colorCorrectionOptions, 'brightness');
	const cycleContrasts = cycleUsingAndStore(contrasts, colorCorrectionOptions, 'contrast');

	const toggleActive = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.active = !ccOptions.active;
		colorCorrectionOptions.set(ccOptions);
	}

	/*
	const toggleSimulation = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.simulate = !ccOptions.simulate;
		colorCorrectionOptions.set(ccOptions);
	}
	*/

	/*
	// Old
	const cycleColorModels = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.colorModel = nextColorModels[ccOptions.colorModel] || colorModels[0];
		colorCorrectionOptions.set(ccOptions);
	}
	const cycleHues = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.hue = nextHues[ccOptions.hue] || hues[0];
		colorCorrectionOptions.set(ccOptions);
	}
	const cycleGrayscales = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.grayscale = nextGrayscales[ccOptions.contrast] || contrasts[0];
		colorCorrectionOptions.set(ccOptions);
	}
	const cycleBrightnesses = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.grayscale = nextGrayscales[ccOptions.contrast] || contrasts[0];
		colorCorrectionOptions.set(ccOptions);
	}
	const cycleContrasts = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.grayscale = nextGrayscales[ccOptions.contrast] || contrasts[0];
		colorCorrectionOptions.set(ccOptions);
	}
	const cycleInverts = () => {
		const ccOptions = get(colorCorrectionOptions);
		ccOptions.grayscale = nextGrayscales[ccOptions.contrast] || contrasts[0];
		colorCorrectionOptions.set(ccOptions);
	}
	*/

	onMount( () => {
		cycleFont();
		cycleLineHeight();
		cycleWordSpacing();
		cycleLetterSpacing();
	})
</script>
<div>
	<header>Fonts and Text</header>
	<button on:click={cycleFont}>Font: {$fontFamily}</button>
	<button on:click={cycleSize}>Scale: {$fontScaling}</button>
	<button on:click={cycleLineHeight}>Line height: {$lineHeight}</button>
	<button on:click={cycleLetterSpacing}>Letter spacing: {$letterSpacing}</button>
	<button on:click={cycleWordSpacing}>Word spacing: {$wordSpacing}</button>
	<button disabled={!variationsEnabled} on:click={cycleVariation}>Settings: {$fontVariationSettings}</button>
	<header>Color Vision Deficiencies</header>
	<button on:click={toggleActive}>Active: {$colorCorrectionOptions.active}</button>
	<button on:click={cycleInverts}>Invert: {$colorCorrectionOptions.invert}%</button>
	<button on:click={cycleColorModels}>Model: {$colorCorrectionOptions.colorModel}</button>
	{#if $colorCorrectionOptions.colorModel === 'hue'}
		<button on:click={cycleHues}>Hue: {$colorCorrectionOptions['hue-rotate']}deg</button>
	{:else if $colorCorrectionOptions.colorModel === 'grayscale'}
		<button on:click={cycleGrayscales}>Grayscale: {$colorCorrectionOptions.grayscale}%</button>
	{/if}
	<button on:click={cycleBrightnesses}>Brightness: {$colorCorrectionOptions.brightness}%</button>
	<button on:click={cycleContrasts}>Contrast: {$colorCorrectionOptions.contrast}%</button>
	<!-- <button on:click={toggleSimulation}>Simulate: {$colorCorrectionOptions.simulate}</button> -->
</div>

<style>
	div {
		position: fixed;
		top: 5em;
		left: 2em;
		background: white;
		border: thin solid black;
		z-index: 1;
	}
	button {
		display: block;
	}
</style>