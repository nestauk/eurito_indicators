<script>
	import Switch from '@svizzle/ui/src/Switch.svelte';
	import Icon from '@svizzle/ui/src/icons/Icon.svelte';
	import ChevronLeft from '@svizzle/ui/src/icons/feather/ChevronLeft.svelte';
	import ChevronRight from '@svizzle/ui/src/icons/feather/ChevronRight.svelte';

	import ColorClear from './glyphs/ColorClear.svelte'
	import FormatClear from './glyphs/FormatClear.svelte'

	import * as _ from 'lamb';

	import {
		currentSetting,
		formatValue,
		groupsResetStatus,
		hasNext,
		hasPrev,
		resetGroup,
		setNextId,
		setPrevId,
		updateCurrentValue,
	} from 'app/stores/a11ySettings';

	export let screen;

	let label;
	let showLabels;

	const mapToStringLengths = strings => strings?.map(
		i => i.toString().length
	);

	$: showLabels = Math.max(
		...(mapToStringLengths($currentSetting.values) || [0])
	) < 5;
	$: label = `${$currentSetting.label}: ${$formatValue($currentSetting.value)}`;
</script>

<dialog class={screen?.classes}>
	<nav class='resets'>
		<div
			class='text'
			class:clickable={!$groupsResetStatus.text}
			on:click={() => resetGroup('text')}
		>
			<Icon
				fill={$groupsResetStatus.text ? 'silver' : 'black'}
				glyph={FormatClear}
				stroke='none'
			/>
		</div>
		<div
			class='color'
			class:clickable={!$groupsResetStatus.color}
			on:click={() => resetGroup('color')}
		>
			<Icon
				fill={$groupsResetStatus.color ? 'silver' : 'black'}
				glyph={ColorClear}
				stroke='none'
			/>
		</div>
	</nav>
	<menu>
		<label for=''>{label}</label>
		{#if $currentSetting.values}
			<div class='controlContainer'>
				{#each $currentSetting.values as value, index}
					<div>
						<label for='input-{index}'>
							{#if showLabels}
								{$formatValue(value)}
							{/if}
						</label>
						<input
							name='input-{index}'
							checked={$currentSetting.value === value}
							class='clickable'
							on:change={() => updateCurrentValue(value)}
							type='radio'
							{value}
						>
					</div>
				{/each}
			</div>
		{:else if $currentSetting.range}
			<div class='slider'>
				<span>
					{$formatValue($currentSetting.range[0])}
				</span>
				<input
					class='clickable'
					max={$currentSetting.range[1]}
					min={$currentSetting.range[0]}
					name={$currentSetting.id}
					on:input={({target: {value}}) => updateCurrentValue(value)}
					type='range'
					value={$currentSetting.value}
				>
				<span>
					{$formatValue($currentSetting.range[1])}
				</span>
			</div>
		{:else if $currentSetting.format === 'boolean'}
			<Switch
				on:toggled={({detail}) => updateCurrentValue(detail === 'Yes')}
				value={$formatValue($currentSetting.value)}
				values={['No', 'Yes']}
			/>
		{/if}
	</menu>
	<nav class='nav'>
		<button
			class:clickable={$hasPrev}
			disabled={!$hasPrev}
			on:click={setPrevId}
		>
			<Icon glyph={ChevronLeft} />
		</button>
		<button
			class:clickable={$hasNext}
			disabled={!$hasNext}
			on:click={setNextId}
		>
			<Icon glyph={ChevronRight} />
		</button>
	</nav>
</dialog>

<style>
	dialog {
		background: white;
		border-bottom: thin solid black;
		border-top: thin solid black;
		border: none;
		display: grid;
		font-family: sans-serif;
		font-size: 16px;
		grid-template-areas: 'resets proppanel nav';
		grid-template-columns: min-content 1fr min-content;
		height: 80px;
		letter-spacing: 0;
		line-height: 24px;
		position: relative;
		width: 100%;
		word-spacing: 0;
		z-index: var(--z-1000);
	}
	dialog.medium {
		bottom: 150px;
		left: 50%;
		margin-left: -240px;
		position: fixed;
		width: 480px;
	}
	nav {
		display: grid;
		grid-template-areas: 'upper' 'lower';
		grid-template-rows: 50% 50%;
	}
	.resets {
		grid-area: resets;
	}
	menu {
		display: grid;
		grid-area: proppanel;
		justify-items: center;
	}
	.nav {
		grid-area: nav;
	}
	label {
		display: block;
		text-align: center;
		white-space: nowrap;
	}
	span, label {
		user-select: none;
	}
	.controlContainer {
		display: grid;
		gap: 24px;
		grid-auto-columns: 1fr;
		grid-auto-flow: column;
		text-align: center;
		width: min-content;
	}
	.xSmall .controlContainer {
		gap: 12px;
	}
	button, .text, .color {
		align-items: center;
		background: white;
		background: white;
		border-left: thin solid black;
		border-right: thin solid black;
		border: none;
		box-sizing: border-box;
		display: block;
		display: grid;
		height: 39px;
		justify-items: center;
		margin: 0;
		text-align: center;
		width: 39px;
	}
	nav :first-child {
		border-bottom: thin solid black;
	}
	.slider {
		align-items: center;
		display: grid;
		gap: 8px;
		grid-auto-flow: column;
	}
	input[type="range"] {
		-webkit-appearance: none;
	}
	input[type="range"]:focus {
		outline: none;
	}
	input[type="range"]::-moz-range-track {
		background: black;
		border: none;
		box-sizing: border-box;
		height: 1px;
		width: 129px;
	}
	input[type="range"]::-webkit-slider-runnable-track {
		-webkit-appearance: none;
		background: black;
		border: none;
		box-sizing: border-box;
		height: 1px;
		width: 129px;
	}
	input[type="range"]::-moz-range-thumb {
		background: black;
		border-radius: 50%;
		border: none;
		height: 19px;
		margin-top: -9px;
		width: 19px;
	}
	input[type="range"]::-webkit-slider-thumb {
		-webkit-appearance: none;
		background: black;
		border-radius: 50%;
		border: none;
		height: 19px;
		margin-top: -9px;
		width: 19px;
	}
</style>
