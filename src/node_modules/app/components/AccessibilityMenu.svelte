<script>
	import Switch from '@svizzle/ui/src/Switch.svelte';
	import Icon from '@svizzle/ui/src/icons/Icon.svelte';
	import ChevronLeft from '@svizzle/ui/src/icons/feather/ChevronLeft.svelte';
	import ChevronRight from '@svizzle/ui/src/icons/feather/ChevronRight.svelte';
	import ColorClear from './glyphs/ColorClear.svelte'
	import FormatClear from './glyphs/FormatClear.svelte'

	import * as _ from 'lamb';

	import {a11ySettings} from 'app/stores/a11ySettings';

	export let screen;

	let currentId = 'typeface';
	let currentValue;
	let hasPrev;
	let hasNext;
	let showLabels;
	let formattedValue;
	let label;
	let isTextGroupModified;
	let isColorGroupModified;

	const updateIndexOf = (id, index) => {
		const setting = $a11ySettings[id];

		$a11ySettings[id].currentValueIndex = index;
		$a11ySettings[id].value = setting.values[index];
	};
	const resetIndexOf = id => {
		const setting = $a11ySettings[id];
		$a11ySettings[id] = _.merge(setting, {
			currentValueIndex: setting.defaultValueIndex,
			value: setting.values[setting.defaultValueIndex]
		});
	};
	const updateValueOf = (id, value) => {
		const setting = $a11ySettings[id];
		$a11ySettings[id] = _.merge(setting, {value});
	};
	const resetValueOf = id => {
		const setting = $a11ySettings[id];
		$a11ySettings[id] = _.merge(setting, {
			value: setting.defaultValue
		});
	};
	const defaultValueOf = id => $a11ySettings[id].defaultValue
	const defaultIndexOf = id => $a11ySettings[id].defaultValueIndex

	const updateSetting = (id, value) => {
		if ($a11ySettings[id].values) {
			updateIndexOf(id, value);
		} else {
			updateValueOf(id, value);
		}
	};
	const resetGroup = groupId => {
		Object.keys($a11ySettings)
		.filter(id => $a11ySettings[id].group === groupId)
		.forEach(id => {
			$a11ySettings[id].values
					? resetIndexOf(id)
					: resetValueOf(id)
		});
		currentValue = getValueFrom(currentId);
	};
	const isGroupModified = groupId => Object.keys($a11ySettings)
		.filter(id => $a11ySettings[id].group === groupId)
		.some(id => getValueFrom(id) !== (
			$a11ySettings[id].values
				? defaultIndexOf(id)
				: defaultValueOf(id)
		));

	const getValueFrom = id => $a11ySettings[id].values
		? $a11ySettings[id].currentValueIndex
		: $a11ySettings[id].value;

	const nextSetting = () => currentId = $a11ySettings[currentId].next;
	const prevSetting = () => currentId = $a11ySettings[currentId].prev;

	const formats = {
		'percentage': value => `${value}%`,
		'degrees': value => `${value}Â°`,
		'boolean': value => value ? 'Yes' : 'No',
	};
	const formatValue = (value) => {
		const format = $a11ySettings[currentId].format;
		return format
			? formats[format](value)
			: value
	}
	const mapToStringLengths = strings => strings?.map(
		i => i.toString().length
	);

	$: hasPrev = $a11ySettings[currentId].prev !== null;
	$: hasNext = $a11ySettings[currentId].next !== null;
	$: currentValue = getValueFrom(currentId);
	$: updateSetting(currentId, currentValue);
	$: showLabels = Math.max(
		...(mapToStringLengths($a11ySettings[currentId].values) || [0])
	) < 5;
	$: formattedValue = formatValue($a11ySettings[currentId].value);
	$: label = `${$a11ySettings[currentId].label}: ${formattedValue}`;
	$: currentValue, isTextGroupModified = isGroupModified('text');
	$: currentValue, isColorGroupModified = isGroupModified('color');
</script>

<dialog class={screen?.classes}>
	<nav class='resets'>
		<div class='text' on:click={() => resetGroup('text')}>
			<Icon glyph={FormatClear} fill={isTextGroupModified?'black': 'silver'} stroke={'none'} />
		</div>
		<div class='color' on:click={() => resetGroup('color')}>
			<Icon glyph={ColorClear} fill={isColorGroupModified?'black': 'silver'} stroke={'none'} />
		</div>
	</nav>
	<menu>
		<label for=''>{label}</label>
		{#if $a11ySettings[currentId].values}
			<div class='controlContainer'>
				{#each $a11ySettings[currentId].values as value, index}
					<div>
						<label for={`input-${index}`}>
							{#if showLabels}
								{formatValue(value)}
							{/if}
						</label>
						<input 
							bind:group={currentValue}
							name={`input-${index}`}
							type='radio'
							value={index}
						>
					</div>
				{/each}
			</div>
		{:else if $a11ySettings[currentId].range}
			<div class='slider'>
				<span>
					{formatValue($a11ySettings[currentId].range[0])}
				</span>
				<input 
					class='clickable'
					name='hue'
					type='range'
					min={$a11ySettings[currentId].range[0]}
					max={$a11ySettings[currentId].range[1]}
					bind:value={currentValue}
				>
				<span>
					{formatValue($a11ySettings[currentId].range[1])}
				</span>
			</div>
		{:else if $a11ySettings[currentId].format === 'boolean'}
			<Switch
				value={formatValue($a11ySettings[currentId].value)}
				values={['No', 'Yes']}
				on:toggled={event => {
					currentValue = event.detail === 'Yes'
				}}
			/>
		{/if}
	</menu>
	<nav class='nav'>
		<button
			class:clickable={hasPrev}
			disabled={!hasPrev}
			on:click={prevSetting}
		>
			<Icon glyph={ChevronLeft} />
		</button>
		<button
			class:clickable={hasNext}
			disabled={!hasNext}
			on:click={nextSetting}
		>
			<Icon glyph={ChevronRight} />
		</button>
	</nav>
</dialog>

<style>
	dialog {
		position: relative;
		display: grid;
		width: 100%;
		height: 80px;
		background: white;
		border: none;
		border-top: thin solid black;
		border-bottom: thin solid black;
		z-index: var(--z-1000);
		grid-template-areas: 'resets proppanel nav';
		grid-template-columns: min-content 1fr min-content;
		font-family: sans-serif;
		font-size: 16px;
		line-height: 24px;
		letter-spacing: 0;
		word-spacing: 0;
	}
	dialog.medium {
		position: fixed;
		width: 480px;
		bottom: 150px;
		left: 50%;
		margin-left: -240px;
	}
	nav {
		display: grid;
		grid-template-areas: 'upper' 'lower';
		grid-template-rows: 50% 50%;
	}
	.resets {
		grid-area: resets;
	}
	menu {
		grid-area: proppanel;
		display: grid;
		justify-items: center;
	}
	.nav {
		grid-area: nav;
	}
	label {
		display: block;
		text-align: center;
		white-space: nowrap;
	}
	.controlContainer {
		display: grid;
		grid-auto-columns: 1fr;
		grid-auto-flow: column;
		text-align: center;
		width: min-content;
		gap: 24px;
	}
	.xSmall .controlContainer {
		gap: 12px;
	}
	button, .text, .color {
		display: block;
		width: 39px;
		height: 39px;
		box-sizing: border-box;
		text-align: center;
		border: none;
		border-left: thin solid black;
		border-right: thin solid black;
		background: white;
		margin: 0;
		display: grid;
		align-items: center;
		justify-items: center;
		background: white;
	}
	nav :first-child {
		border-bottom: thin solid black;
	}
	.slider {
		display: grid;
		align-items: center;
		grid-auto-flow: column;
		gap: 8px;
	}
	input[type="range"] {
		-webkit-appearance: none;
	}
	input[type="range"]:focus {
		outline: none;
	}
	input[type="range"]::-moz-range-track {
		background: black;
		width: 129px;
		height: 1px;
		box-sizing: border-box;
		border: none;
	}
	input[type="range"]::-webkit-slider-runnable-track {
		-webkit-appearance: none;
		background: black;
		width: 129px;
		height: 1px;
		box-sizing: border-box;
		border: none;
	}
	input[type="range"]::-moz-range-thumb {
		border: none;
		height: 19px;
		width: 19px;
		background: black;
		margin-top: -9px;
		border-radius: 50%;
	}
	input[type="range"]::-webkit-slider-thumb {
		border: none;
		-webkit-appearance: none;
		height: 19px;
		width: 19px;
		background: black;
		margin-top: -9px;
		border-radius: 50%;
	}
</style>