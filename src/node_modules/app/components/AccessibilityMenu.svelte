<script context='module'>
	import {derived} from 'svelte/store';
	import * as _ from 'lamb';
	import {makeStyle} from '@svizzle/dom'

	import {a11ySettings} from 'app/stores/a11ySettings';

	// const defaultFontSize = () => document && window.getComputedStyle(document.documentElement).fontSize;

	const styleFormatters = {
		typeface: value => ['font-family', `"${value}"`],
		fontScaling: value => ['font-size', `${value/100}rem`],
		lineHeight: value => ['line-height', `${value/100}rem`],
		letterSpacing: value => ['letter-spacing', `${value/100}rem`],
		wordSpacing: value => ['word-spacing', `${value/100}rem`],
	}

	const format = setting => setting.id in styleFormatters && styleFormatters[setting.id](setting.value)

	const getStyles = _.pipe([
		_.values,
		_.mapWith(format),
		_.fromPairs,
	])

	export const a11yStyles = derived(a11ySettings, getStyles);
	export const applyStyles = (domStyle, styles) => {
		Object.entries(styles)
		.forEach(([prop, value]) => domStyle[prop] = value);
		/*
		_.pipe([
			_.pairs(styles),
			_.mapWith(([prop, value]) => domStyle[prop] = value)
		])(styles);
		*/
	}
</script>

<script>


	// import ColorCorrection from 'app/components/ColorCorrection.svelte';
	import Switch from '@svizzle/ui/src/Switch.svelte';
	import Icon from '@svizzle/ui/src/icons/Icon.svelte'
	import ChevronLeft from '@svizzle/ui/src/icons/feather/ChevronLeft.svelte';
	import ChevronRight from '@svizzle/ui/src/icons/feather/ChevronRight.svelte';
	import ColorClear from 'app/components/icon-glyphs/ColorClear.svelte'
	import FormatClear from 'app/components/icon-glyphs/FormatClear.svelte'

	// let active = true;
	
	let currentId = 'typeface'
	let currentValue;
	let hasPrev;
	let hasNext;

	const updateIndexOf = (id, index) => {
		const setting = $a11ySettings[id];

		$a11ySettings[id].currentValueIndex = index;
		$a11ySettings[id].value = setting.values[index];
	};
	const resetIndexOf = id => {
		const setting = $a11ySettings[id];
		$a11ySettings[id] = _.merge(setting, {
			currentValueIndex: setting.defaultValueIndex,
			value: setting.values[setting.defaultValueIndex]
		});
	};
	const updateValueOf = (id, value) => {
		const setting = $a11ySettings[id];
		$a11ySettings[id] = _.merge(setting, {value});
	};
	const resetValueOf = id => {
		const setting = $a11ySettings[id];
		$a11ySettings[id] = _.merge(setting, {
			value: setting.defaultValue
		});
	};

	const updateSetting = (id, value) => {
		if ($a11ySettings[id].values) {
			updateIndexOf(id, value);
		} else {
			updateValueOf(id, value);
		}
	}

		// const toggleActive = () => active = !active;

	const getValueFrom = id => $a11ySettings[id].values
		? $a11ySettings[id].currentValueIndex
		: $a11ySettings[id].value;

	const nextSetting = () => currentId = $a11ySettings[currentId].next;
	const prevSetting = () => currentId = $a11ySettings[currentId].prev;

	$: hasPrev = $a11ySettings[currentId].prev !== null;
	$: hasNext = $a11ySettings[currentId].next !== null;
	$: currentValue = getValueFrom(currentId)
	$: updateSetting(currentId, currentValue);
	$: console.log($a11ySettings[currentId]);
	$: console.log($a11yStyles);
</script>

<!-- ColorCorrection options={$colorCorrectionOptions} /-->

<section>
	<header>
		<out class='text'><Icon glyph={FormatClear} /></out>
		<out class='color'><Icon glyph={ColorClear} fill={'bkack'} stroke={'none'} /></out>
	</header>
	<menu>
		<label for=''>{$a11ySettings[currentId].label}: {$a11ySettings[currentId].value}</label>
		{#if $a11ySettings[currentId].values}
			<div class='layout-2'>
				{#each $a11ySettings[currentId].values as value, index}
				<div>
					<label for={`input-${index}`}>{value}</label>
					<input 
						name={`input-${index}`}
						type="radio"
						bind:group={currentValue}
						value={index}
					>
				</div>
				{/each}
			</div>
		{:else if $a11ySettings[currentId].range}
			<div class='.layout-2'>
				<input 
					name='hue'
					type='range'
					min={$a11ySettings[currentId].range[0]}
					max={$a11ySettings[currentId].range[1]}
					bind:value={currentValue}>
			</div>
		{:else if $a11ySettings[currentId].format === 'boolean'}
			<Switch
				value={currentValue ? 'No' : 'Yes'}
				values={['No', 'Yes']}
				on:toggled={event => {
					currentValue = event.detail === 'Yes'
				}}
			/>
		{/if}
	</menu>
	<nav>
		<button disabled={!hasPrev} on:click={prevSetting}>
			<Icon glyph={ChevronLeft} />
		</button>
		<button disabled={!hasNext} on:click={nextSetting}>
			<Icon glyph={ChevronRight} />
		</button>
	</nav>
</section>

<style>
	section {
		display: grid;
		width: 100%;
		height: 4.5rem;
		background: white;
		border: thin solid black;
		z-index: 1;
		grid-template-areas: "indicators proppanel nav";
		grid-template-columns: min-content 1fr min-content;
	}
	button {
		display: block;
	}
	header {
		font-family: sans-serif;
		font-size: 16px;
		display: grid;
		grid-template-areas: "upper" "lower";
		grid-template-rows: 50% 50%;
	}
	nav {
		display: grid;
		grid-template-areas: "upper" "lower";
		grid-template-rows: 50% 50%;
	}
	label {
		display: block;
		text-align: center;
	}

	.layout-1, .layout-2 {
		display: grid;
		grid-auto-columns: 1fr;
		grid-auto-flow: column;
		justify-items: center;
		text-align: center;
	}

	.layout-2 {
		grid-template-rows: 1fr;
		align-items: middle;
	}

	button, out {
		width: 2rem;
		height: 2rem;
		box-sizing: border-box;
		text-align: center;
		border: thin solid;
		margin: 0;
	}
</style>
