<script context='module'>
	import {
		cookieStorage,
		localStorage,
		sessionStorage,
		indexedDBStorage,
		noopStorage,
	} from "@macfja/svelte-persistent-store";
	import isEqual from 'just-compare';

	const TYPES = {
		localStorage: isReactive => localStorage(isReactive),
		sesisonStorage: isReactive => sessionStorage(isReactive),
		cookie: () => cookieStorage(),
		indexedDB: () => indexedDBStorage(),
		noop: () => noopStorage()
	};

	const bind = (type, store, key, defaultValue, isReactive) => {
		const storage = TYPES[type](isReactive);
		const initialValue = storage.getValue(key);
		if (null !== initialValue) {
			store.set(initialValue);
		}
		const setValue = newValue => {
			store.set(newValue);
		};
		if (storage.addListener) {
			storage.addListener(key, setValue);
		}
		store.subscribe(value => {
			if (isEqual(defaultValue, value)) {
				storage.deleteValue(key);
			}
			else {
				storage.setValue(key, value);
			}
		});
		return () => {
			storage.removeListener(key, setValue);
		};
	};
</script>

<script>
	export let _store;
	export let defaultValue;
	export let isReactive;
	export let key;
	export let type;

	let unbind;

	$: if (!(type in TYPES)) type = 'noop'; // TODO throw?
	// $: if (!_store.subscribe) // throw?
	$: if (key && type && _store) {
		unbind?.();
		unbind = bind(type, _store, key, defaultValue, isReactive);
	} 
</script>
