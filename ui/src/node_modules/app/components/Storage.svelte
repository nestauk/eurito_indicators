<script context='module'>
	import {
		cookieStorage,
		localStorage,
		sessionStorage,
		indexedDBStorage,
		noopStorage,
	} from "@macfja/svelte-persistent-store";
	import isEqual from 'just-compare';

	const TYPES = {
		localStorage: isReactive => localStorage(isReactive),
		sesisonStorage: isReactive => sessionStorage(isReactive),
		cookie: () => cookieStorage(),
		indexedDB: () => indexedDBStorage(),
		noop: () => noopStorage()
	};

	const bind = ({type, _store, key, defaultValue, isReactive}) => {
		const storage = TYPES[type](isReactive);
		const initialValue = storage.getValue(key) || defaultValue;
		_store.set(initialValue);

		const setStoreValue = newValue => {
			// Current value in storage may be newer than value from event.
			newValue = storage.getValue(key) || defaultValue;
			_store.set(newValue);
		};
		const setStorageValue = value => {
			if (isEqual(defaultValue, value)) {
				storage.deleteValue(key);
			} else {
				storage.setValue(key, value);
			}
		}

		// No infinite loops as both `storage` and `_store`
		// don't fire if the new and old values are the same.
		storage.addListener?.(key, setStoreValue);
		_store.subscribe(setStorageValue);

		return () => {
			storage.removeListener?.(key, setValue);
		};
	};
</script>

<script>
	export let _store = writable();
	export let defaultValue = null;
	export let isReactive = false;
	export let key = null;
	export let type = 'noop';

	let unbind;

	$: if (!(type in TYPES)) type = 'noop';
	$: if (key && type && _store) {
		unbind?.();
		unbind = bind({type, _store, key, defaultValue, isReactive});
	} 
</script>
